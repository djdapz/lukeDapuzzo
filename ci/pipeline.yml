---
resources:

  - name: repo
    type: git
    source:
      uri: ((git-repo))
      private_key: ((github-private-key))

  - name: openjdk
    type: docker-image
    source:
      repository: openjdk
      tag: 8

  - name: postgres
    type: docker-image
    source:
      repository: postgres

  - name: node
    type: docker-image
    source:
      repository: node
      tag: 12

  - name: openjdk-node-cf
    type: docker-image
    source:
      repository: djdapz/openjdk-node-cf

  - name: acceptance
    type: cf
    source:
      api: https://api.run.pivotal.io
      username: ((PCF_USERNAME))
      password: ((PCF_PASSWORD))
      organization: dapuzzo
      space: development

  - name: production
    type: cf
    source:
      api: https://api.run.pivotal.io
      username: ((PCF_USERNAME))
      password: ((PCF_PASSWORD))
      organization: dapuzzo
      space: production

  - name: frontend-s3
    type: s3
    source:
      region_name: us-west-2
      bucket: luke-dapuzzo
      regexp: frontend/frontend-(.*).zip
      access_key_id: ((AWS_ACCESS_KEY_ID))
      secret_access_key: ((AWS_SECRET_ACCESS_KEY))

  - name: backend-s3
    type: s3
    source:
      region_name: us-west-2
      bucket: luke-dapuzzo
      regexp: backend/backend-(.*).zip
      access_key_id: ((AWS_ACCESS_KEY_ID))
      secret_access_key: ((AWS_SECRET_ACCESS_KEY))




  - name: after-midnight
    type: time
    source:
      start: 12:00 AM
      stop: 1:00 AM
      location: America/Chicago


  - name: version
    type: semver
    source:
      driver: git
      uri: git@github.com:djdapz/lukeDapuzzo.git
      branch: version
      file: version
      private_key: ((github-private-key))

jobs:
  - name: stop-dev-environment
    public: true
    plan:
      - get: openjdk-node-cf
        params: {save: true}
      - get: after-midnight
        trigger: true
      - task: stop-frontend
        privileged: true
        image: openjdk-node-cf
        config:
          platform: linux
          run:
            path: sh
            args:
              - -exc
              - |
                set -e
                cf login -a https://api.run.pivotal.io -u ${PCF_USERNAME} -p ${PCF_PASSWORD} -s development -o dapuzzo
                cf stop luke-dapuzzo-api-dev
                cf stop luke-dapuzzo-client
        params:
          PCF_USERNAME: ((PCF_USERNAME))
          PCF_PASSWORD: ((PCF_PASSWORD))


  - name: run-tests-backend
    public: true
    plan:
      - get: version
      - get: repo
        trigger: true
      - get: openjdk
        params: {save: true}
      - get: postgres
        params: {save: true}
      - task: run-tests
        privileged: true
        config:
          platform: linux
          inputs:
            - name: repo
            - name: postgres
            - name: openjdk
          image_resource:
            type: docker-image
            source:
              repository: amidos/dcind
          run:
            path: sh
            args:
              - -exc
              - |
                set -e
                source /docker-lib.sh

                start_docker

                docker load -i postgres/image
                docker tag "$(cat postgres/image-id)" "$(cat postgres/repository):$(cat postgres/tag)"

                docker load -i openjdk/image
                docker tag "$(cat openjdk/image-id)" "$(cat openjdk/repository):$(cat openjdk/tag)"


                docker images

                docker-compose -f repo/ci/docker-compose.tests.yml run unit-integration-tests

                docker-compose -f repo/ci/docker-compose.tests.yml down
                docker volume rm $(docker volume ls -q)
      - put: version
        params: {bump: patch}

  - name: build-and-upload-frontend
    public: true
    plan:
      - get: version
        trigger: true
        passed: ["run-tests-backend"]
      - get: repo
        trigger: true
        passed: ["run-tests-backend"]
      - get: node
        params: {save: true}
      - task: build-and-upload
        privileged: true
        image: node
        config:
          platform: linux
          inputs:
            - name: repo
            - name: version
          outputs:
            - name: frontend-s3
          caches:
            - path: repo/frontend/node_modules
          run:
            path: sh
            args:
              - -exc
              - |
                #!/bin/bash
                set -ex

                export BUILD_VERSION=`cat version/number`

                cd repo/frontend
                npm install
                npm run build
                touch build/Staticfile
                cd build
                zip -r ../../../frontend-s3/frontend-${BUILD_VERSION}.zip *
      - put: frontend-s3
        params:
          file: frontend-s3/frontend-*.zip

  - name: build-and-upload-backend
    public: true
    plan:
      - get: version
        trigger: true
        passed: ["run-tests-backend"]
      - get: repo
        trigger: true
        passed: ["run-tests-backend"]
      - get: openjdk
        params: {save: true}
      - task: build-and-upload
        privileged: true
        image: openjdk
        config:
          platform: linux
          inputs:
            - name: repo
            - name: version
          outputs:
            - name: backend-s3
          run:
            path: sh
            args:
              - -exc
              - |
                #!/bin/bash
                set -ex

                export BUILD_VERSION=`cat version/number`
                cd repo

                ./gradlew clean assemble -Pversion=$BUILD_VERSION
                pwd
                cp build/libs/luke-dapuzzo-${BUILD_VERSION}.jar ../backend-s3/backend-${BUILD_VERSION}.jar
      - put: backend-s3
        params:
          file: backend-s3/backend-*.jar

  - name: deploy-acceptance
    plan:
      - get: repo
        trigger: true
        passed: ["build-and-upload-backend", "build-and-upload-frontend"]
      - get: openjdk-node-cf
        params: {save: true}
      - get: backend-s3
        trigger: true
        passed:  ["build-and-upload-backend"]
      - get: frontend-s3
        trigger: true
        passed:  ["build-and-upload-frontend"]
      - task: download-jar
        privileged: true
        image: openjdk-node-cf
        config:
          platform: linux
          inputs:
            - name: repo
            - name: version
          outputs:
            - name: deploy
          run:
            path: sh
            args:
              - -exc
              - |
                #!/bin/bash
                set -ex

                cp backend-s3/backend-*.jar  ./deploy/backend.jar
                cp ./repo/ci/manifests/acceptance/server-manifest.yml ./deploy/manifest-backend.yml

                cp frontend-s3/frontend-*.zip  ./deploy/frontend.zip
                cp ./repo/ci/manifests/acceptance/client-manifest.yml ./deploy/manifest-frontend.yml
          params:
            AWS_ACCESS_KEY_ID: ((AWS_ACCESS_KEY_ID))
            AWS_SECRET_ACCESS_KEY: ((AWS_SECRET_ACCESS_KEY))
      - put: acceptance
        params:
          inputs:
            - name: deploy
          path: deploy/backend.jar
          manifest: deploy/manifest-backend.yml
      - put: acceptance
        params:
          inputs:
            - name: deploy
          path: deploy/frontend.zip
          manifest: deploy/manifest-frontend.yml

  - name: deploy-backend-production
    plan:
      - get: repo
        trigger: false
        passed: ["deploy-acceptance"]
      - get: backend-s3
        trigger: true
        passed:  ["deploy-acceptance"]
      - get: frontend-s3
        trigger: true
        passed:  ["deploy-acceptance"]
      - get: openjdk-node-cf
        params: {save: true}
      - task: download-jar
        privileged: true
        image: openjdk-node-cf
        config:
          platform: linux
          inputs:
            - name: repo
            - name: version
          outputs:
            - name: deploy
          run:
            path: sh
            args:
              - -exc
              - |
                #!/bin/bash

                 export BUILD_VERSION=`cat version/number`

                 /root/bin/aws s3 cp  "s3://luke-dapuzzo/app/luke-dapuzzo-${BUILD_VERSION}.jar"  ./deploy/backend.jar
                 cp ./repo/ci/manifests/production/server-manifest.yml ./deploy/manifest-backend.yml

                 /root/bin/aws s3 cp  "s3://luke-dapuzzo/app/frontend-${BUILD_VERSION}.zip"  ./deploy/frontend.zip
                 cp ./repo/ci/manifests/production/client-manifest.yml ./deploy/manifest-frontend.yml
          params:
            AWS_ACCESS_KEY_ID: ((AWS_ACCESS_KEY_ID))
            AWS_SECRET_ACCESS_KEY: ((AWS_SECRET_ACCESS_KEY))
      - put: production
        params:
          inputs:
            - name: deploy
          path: deploy/frontend.zip
          manifest: deploy/manifest-frontend.yml
      - put: production
        params:
          inputs:
            - name: deploy
          path: deploy/backend.jar
          manifest: deploy/manifest-backend.yml
